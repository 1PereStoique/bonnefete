<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Récit d'une vie</title>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body { margin:0; padding:0; height:100%; width:100%; overflow:hidden; font-family:'Georgia', serif; background:url('livre.jpeg') no-repeat center center fixed; background-size:cover; }
    * { box-sizing:border-box; }
    body::before { content:""; position:fixed; inset:0; background:rgba(0,0,0,.1); z-index:0; }
    .feuille { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:60%; height:70%; background:#fdf6e3; border-radius:8px; box-shadow:0 0 30px rgba(0,0,0,.5); background-image:radial-gradient(circle at 50% 50%, rgba(255,255,255,.15), transparent 70%), url('https://www.transparenttextures.com/patterns/paper-fibers.png'); background-blend-mode:multiply; padding:5mm; display:none; z-index:10; }
    textarea { width:100%; height:100%; resize:none; border:none; background:transparent; font-size:1.2rem; line-height:1.6; outline:none; color:#2e2e2e; }
    .fermer { position:fixed; top:10px; left:10px; font-size:20px; font-weight:bold; color:#000; background:rgba(255,255,255,.7); padding:4px 10px; border-radius:5px; cursor:pointer; z-index:20; display:none; }
    .fermer:hover { background:rgba(0,0,0,.1); }
    .message { position:absolute; bottom:40px; right:40px; background:rgba(255,255,255,.8); color:#333; padding:12px 18px; border-radius:10px; font-size:18px; box-shadow:0 0 10px rgba(0,0,0,.3); z-index:5; max-width:300px; text-align:center; cursor:pointer; transition:opacity .3s ease; }
    .message.hidden { opacity:0; pointer-events:none; }
    #loginBox { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(255,255,255,.95); padding:20px; border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,.3); z-index:1000; text-align:center; width:min(90vw,420px); }
    #loginBox input { width:100%; padding:8px; font-size:16px; margin-bottom:8px; }
    #loginActions { display:flex; gap:8px; justify-content:space-between; align-items:center; margin-top:6px; }
    #loginBtn { padding:8px 16px; font-size:16px; border:none; background:#28a745; color:#fff; border-radius:5px; cursor:pointer; }
    #resetBtn { padding:8px 12px; font-size:14px; border:none; background:#007bff; color:#fff; border-radius:5px; cursor:pointer; }
    #loginBtn:hover { background:#218838; }
    #resetBtn:hover { background:#0069d9; }
    #loginErr { color:red; font-size:14px; min-height:18px; margin-top:8px; }
    @media (max-width:600px){ html, body{ background-image:url('livre-mobile.jpeg'); background-size:cover; background-position:center; } .message{ bottom:20px; right:20px; font-size:16px; padding:10px 14px; max-width:90%; } .feuille{ width:90%; height:65%; } textarea{ font-size:1rem; } }
    @media (max-width:400px){ .feuille{ width:95%; height:60%; } .message{ font-size:14px; padding:8px 10px; } }
  </style>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <!-- Optionnel: App Check Enterprise si déjà configuré -->
  <!-- <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-check-compat.js"></script> -->
</head>
<body>
  <div class="fermer" id="fermer">✕</div>

  <div class="feuille" id="feuille">
    <textarea id="zoneTexte" placeholder="Commence à écrire ici..." disabled></textarea>
  </div>

  <div class="message" id="message">Clique pour ouvrir le mémoire.</div>

  <div id="loginBox">
    <div style="margin-bottom:10px; font-size:18px;">Connexion requise</div>
    <input type="email" id="loginEmail" placeholder="Email" autocomplete="username" />
    <input type="password" id="loginPass" placeholder="Mot de passe" autocomplete="current-password" />
    <div id="loginActions">
      <button id="loginBtn">Se connecter</button>
      <button id="resetBtn" title="Envoyer un email pour changer le mot de passe">Réinitialiser mot de passe</button>
    </div>
    <div id="loginErr"></div>
  </div>

  <script>
    // Refs UI
    const feuille   = document.getElementById('feuille');
    const zoneTexte = document.getElementById('zoneTexte');
    const fermer    = document.getElementById('fermer');
    const message   = document.getElementById('message');
    const loginBox  = document.getElementById('loginBox');
    const loginEmail= document.getElementById('loginEmail');
    const loginPass = document.getElementById('loginPass');
    const loginBtn  = document.getElementById('loginBtn');
    const resetBtn  = document.getElementById('resetBtn');
    const loginErr  = document.getElementById('loginErr');
    let feuilleVisible = false;

    // Firebase config (inchangé)
    const firebaseConfig = {
      apiKey: "AIzaSyB7lTAbKaCj-tqc3tUd5ndqG__hZX51OT4",
      authDomain: "memoire-partagee.firebaseapp.com",
      databaseURL: "https://memoire-partagee-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "memoire-partagee",
      storageBucket: "memoire-partagee.firebasestorage.app",
      messagingSenderId: "636389110935",
      appId: "1:636389110935:web:e85c5d5d26753f9ee065d2"
    };

    firebase.initializeApp(firebaseConfig);

    // Optionnel: activer App Check si clé dispo
    // const appCheck = firebase.appCheck();
    // appCheck.activate("CLÉ_RECAPTCHA_ENTERPRISE_SITE", true);

    const auth = firebase.auth();
    const db   = firebase.database();

    function afficherZoneTexte() {
      feuille.style.display = 'block';
      fermer.style.display = 'block';
      feuilleVisible = true;
      message.classList.add('hidden');
      zoneTexte.focus();
    }
    function cacherZoneTexte() {
      feuille.style.display = 'none';
      fermer.style.display = 'none';
      feuilleVisible = false;
      message.classList.remove('hidden');
      zoneTexte.blur();
    }

    // ouverture uniquement via la bulle
    message.addEventListener('click', (e) => {
      e.stopPropagation();
      if (!feuilleVisible) {
        if (!auth.currentUser) {
          loginBox.style.display = 'block';
          loginEmail.focus();
        } else {
          afficherZoneTexte();
        }
      }
    });

    // ne pas propager les clics dans la box
    [loginBox, loginEmail, loginPass, loginBtn, resetBtn].forEach(el => {
      el.addEventListener('click', (e) => e.stopPropagation());
    });

    // Login
    loginBtn.addEventListener('click', async () => {
      loginErr.textContent = '';
      const email = loginEmail.value.trim();
      const pass  = loginPass.value;
      if (!email || !pass) { loginErr.textContent = 'Email et mot de passe requis'; return; }
      try {
        await auth.signInWithEmailAndPassword(email, pass);
        loginBox.style.display = 'none';
      } catch (e) {
        loginErr.textContent = 'Identifiants invalides';
      }
    });

    // Reset password
    resetBtn.addEventListener('click', async (e) => {
      e.stopPropagation();
      loginErr.textContent = '';
      const email = loginEmail.value.trim();
      if (!email) { loginErr.textContent = 'Saisis l’email pour recevoir le lien de reset'; return; }
      try {
        await auth.sendPasswordResetEmail(email);
        loginErr.style.color = 'green';
        loginErr.textContent = 'Email de réinitialisation envoyé';
        setTimeout(()=>{ loginErr.textContent=''; loginErr.style.color='red'; }, 4000);
      } catch (err) {
        loginErr.textContent = 'Erreur envoi email';
      }
    });

    // Enter dans mot de passe
    loginPass.addEventListener('keydown', (e) => { if (e.key === 'Enter') loginBtn.click(); });

    fermer.addEventListener('click', (e) => {
      e.stopPropagation();
      cacherZoneTexte();
      auth.signOut().catch(()=>{});
    });

    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && feuilleVisible) cacherZoneTexte(); });

    // DB
    let texteRef = null;
    function attachDb() {
      if (texteRef) return;
      texteRef = db.ref('texteMemoire');

      texteRef.on('value', (snap) => {
        const data = snap.val();
        if (typeof data === 'string' && data !== zoneTexte.value) zoneTexte.value = data;
      });

      let t = 0;
      zoneTexte.disabled = false;
      zoneTexte.addEventListener('input', () => {
        const now = Date.now();
        if (now - t < 500) return;
        t = now;
        const val = zoneTexte.value;
        if (typeof val === 'string' && val.length <= 20000) texteRef.set(val);
      });
    }

    // Vérif des droits via custom claims (editor:true)
    async function userHasEditorClaim(user) {
      if (!user) return false;
      const idTokenResult = await user.getIdTokenResult(true);
      return !!(idTokenResult && idTokenResult.claims && idTokenResult.claims.editor === true);
    }

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        if (texteRef) { texteRef.off(); texteRef = null; }
        zoneTexte.value = '';
        zoneTexte.disabled = true;
        cacherZoneTexte();
        return;
      }
      try {
        const ok = await userHasEditorClaim(user);
        if (!ok) {
          loginErr.textContent = "Accès refusé";
          loginBox.style.display = 'block';
          await auth.signOut();
          return;
        }
        attachDb();
        afficherZoneTexte();
      } catch (err) {
        loginErr.textContent = "Erreur d'authentification";
        await auth.signOut();
      }
    });
  </script>
</body>
</html>
